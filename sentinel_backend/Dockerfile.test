FROM python:3.10-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies directly (avoid editable install for tests)
RUN pip install --no-cache-dir \
    fastapi==0.100.1 \
    uvicorn[standard]==0.22.0 \
    sqlalchemy==2.0.23 \
    asyncpg==0.28.0 \
    psycopg2-binary==2.9.6 \
    pgvector==0.2.0 \
    alembic==1.11.1 \
    prance \
    openapi-core==0.18.0 \
    pyyaml==6.0 \
    schedule==1.2.0 \
    openai==1.54.3 \
    tiktoken==0.7.0 \
    anthropic==0.39.0 \
    google-generativeai==0.3.0 \
    mistralai==0.0.7 \
    aiohttp==3.9.1 \
    pyjwt==2.8.0 \
    bcrypt==4.0.1 \
    python-multipart==0.0.6 \
    email-validator==2.0.0 \
    python-dotenv==1.1.1 \
    pydantic[email]==2.9.2 \
    pydantic-settings==2.0.0 \
    Faker==22.0.0 \
    structlog==23.3.0 \
    python-json-logger==2.0.7 \
    prometheus-fastapi-instrumentator==6.0.0 \
    opentelemetry-api==1.26.0 \
    opentelemetry-sdk==1.26.0 \
    opentelemetry-exporter-jaeger==1.21.0 \
    opentelemetry-instrumentation-fastapi==0.47b0 \
    pika==1.3.2

# Install additional test dependencies
RUN pip install --no-cache-dir \
    pytest \
    pytest-asyncio \
    pytest-cov \
    pytest-mock \
    pytest-xdist \
    "httpx<0.28.0" \
    factory-boy \
    freezegun \
    aioresponses \
    aio-pika \
    psutil

# Create sentinel_backend directory structure
RUN mkdir -p /app/sentinel_backend

# Copy source code to the proper location
COPY . /app/sentinel_backend/

# Create test reports directory
RUN mkdir -p /app/test_reports

# Set environment variables
ENV PYTHONPATH=/app
ENV SENTINEL_ENVIRONMENT=testing

# Set working directory to sentinel_backend for tests
WORKDIR /app/sentinel_backend

# Default command (can be overridden)
CMD ["pytest", "-v", "--tb=short", "--cov=.", "--cov-report=html:/app/test_reports/htmlcov", "--cov-report=xml:/app/test_reports/coverage.xml", "--cov-report=term-missing"]
