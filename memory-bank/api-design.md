# API Design: Sentinel Internal REST APIs

This document outlines the high-level design for the internal REST APIs that the Sentinel services will use to communicate with each other. The API Gateway will serve as the public-facing entry point, routing requests to these internal services.

All APIs will be designed following RESTful principles and will be documented using the OpenAPI 3.0 Specification, automatically generated by FastAPI.

---

## 1. Specification Service API

-   **Base Path:** `/api/v1/specifications`
-   **Responsibilities:** Manages the ingestion and retrieval of API specifications.

| Endpoint                             | Method | Description                                                                                                 |
| ------------------------------------ | ------ | ----------------------------------------------------------------------------------------------------------- |
| `/`                                  | `POST` | Ingest a new API specification from a file upload or a remote URL. Triggers parsing and analysis.           |
| `/`                                  | `GET`  | List all ingested API specifications.                                                                       |
| `/{spec_id}`                         | `GET`  | Retrieve a specific API specification by its ID, including its parsed content and readiness score.          |
| `/{spec_id}`                         | `PUT`  | Update an API specification's metadata (title, description, version, source URL).                           |
| `/{spec_id}`                         | `DELETE`| Delete an API specification.                                                                                |

---

## 2. Test Case & Suite Service API

-   **Base Path:** `/api/v1/`
-   **Responsibilities:** Manages test cases and the suites that group them. This functionality might be part of the `Data & Analytics Service`.

| Endpoint                             | Method | Description                                                                                                 |
| ------------------------------------ | ------ | ----------------------------------------------------------------------------------------------------------- |
| `/test-cases`                        | `POST` | Create a new test case (typically done by agents).                                                          |
| `/test-cases`                        | `GET`  | List all generated test cases, with filtering by agent type, tags, etc.                                     |
| `/test-cases/{case_id}`              | `GET`  | Retrieve a specific test case.                                                                              |
| `/test-cases/{case_id}`              | `PUT`  | Update a test case.                                                                                         |
| `/test-cases/{case_id}`              | `DELETE`| Delete a test case.                                                                                        |
| `/test-cases/bulk-delete`            | `DELETE`| Bulk delete multiple test cases with dependency checking and force delete option.                          |
| `/test-suites`                       | `POST` | Create a new test suite.                                                                                    |
| `/test-suites`                       | `GET`  | List all available test suites.                                                                             |
| `/test-suites/{suite_id}`            | `GET`  | Retrieve a specific test suite, including the list of test cases it contains.                               |
| `/test-suites/{suite_id}`            | `PUT`  | Update a test suite (name, description).                                                                    |
| `/test-suites/{suite_id}`            | `DELETE`| Delete a test suite.                                                                                       |
| `/test-suites/{suite_id}/cases`      | `POST` | Add a test case to a suite.                                                                                 |
| `/test-suites/{suite_id}/cases/{case_id}` | `DELETE`| Remove a test case from a suite.                                                                            |

---

## 3. Test Execution & Orchestration API

-   **Base Path:** `/api/v1/`
-   **Responsibilities:** Triggers test runs and manages the agentic workflow.

| Endpoint                             | Method | Description                                                                                                 |
| ------------------------------------ | ------ | ----------------------------------------------------------------------------------------------------------- |
| `/test-runs`                         | `POST` | **The primary endpoint to start a test run.** Takes a `suite_id` and `target_environment` URL. This is the endpoint that CI/CD pipelines will call. |
| `/test-runs`                         | `GET`  | List all historical and ongoing test runs.                                                                  |
| `/test-runs/{run_id}`                | `GET`  | Get the status and summary of a specific test run.                                                          |
| `/test-runs/{run_id}/results`        | `GET`  | Get the detailed, granular results for all test cases within a completed run.                               |
| `/test-runs/{run_id}`                | `DELETE`| Delete a test run and all associated test results (cascade deletion).                                      |
| `/agent-tasks`                       | `POST` | **Internal endpoint** used by the Orchestrator to delegate tasks to agents. Not publicly exposed.           |

---

## 4. Analytics & Reporting API

-   **Base Path:** `/api/v1/analytics`
-   **Responsibilities:** Provides data for the reporting dashboard and trend analysis.

| Endpoint                             | Method | Description                                                                                                 |
| ------------------------------------ | ------ | ----------------------------------------------------------------------------------------------------------- |
| `/trends/failure-rate`               | `GET`  | Get historical failure rate data for a specific suite or endpoint over a time period.                       |
| `/trends/latency`                    | `GET`  | Get historical latency (avg, p95, p99) data for a specific endpoint.                                        |
| `/health-summary`                    | `GET`  | Get an overall health summary for a project or API, including key metrics and recent regressions.           |

---

## 5. Authentication & Authorization

-   **Mechanism:** All public-facing endpoints exposed via the API Gateway will be protected.
-   **API Keys:** For programmatic access (e.g., from CI/CD pipelines), a simple API key or bearer token system will be used.
-   **User Sessions:** For the frontend dashboard, a standard session-based or JWT-based authentication system will be implemented.
-   **RBAC:** The API Gateway will enforce Role-Based Access Control, checking a user's role before forwarding a request to a backend service.
